@page "/scheduling"
@using MessagebirdTools.WebApp.Components.Dialogs
@using MessagebirdTools.WebApp.Models
@using MessagebirdTools.WebApp.Services
@inject IExcelService ExcelService
@inject IFilePathService FilePathService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject TooltipService TooltipService

<PageTitle>Scheduling Management</PageTitle>

<style>
    .schedule-container {
        height: calc(100vh - 100px);
        overflow: hidden;
    }

    .schedule-content {
        height: calc(100% - 80px); /* Adjust based on header height */
    }

    .scrollable-panel {
        height: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .scroll-content {
        flex: 1;
        overflow: auto;
        min-height: 0;
    }
</style>

@if (!isInitialized)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    <MudText>Initializing...</MudText>
}
else
{
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="schedule-container pa-4">
        <MudPaper Class="pa-4 mb-4">
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="MudBlazor.Variant.Filled" Color="Color.Primary" OnClick="OpenAddDialog" StartIcon="@Icons.Material.Filled.AddAlarm">Add New Schedule</MudButton>
                <MudSpacer />
                <MudSwitch @bind-Value="@showTable" Color="Color.Primary" Label="Show Table" />
                <MudSwitch @bind-Value="@showCalendar" Color="Color.Primary" Label="Show Calendar" />
            </MudStack>
        </MudPaper>

        @if (scheduleList.Count == 0)
        {
            <MudAlert Severity="Severity.Info">No schedules found. Add a new schedule to get started.</MudAlert>
        }
        else
        {
            <MudGrid Class="schedule-content">
            @if (showTable)
     {
<MudItem xs="@(showCalendar ? 6 : 12)" Class="scrollable-panel">
            <MudPaper Class="pa-4 d-flex flex-column" Style="height: 100%;">
  <div class="scroll-content">
    <MudTable Items="@scheduleList" Dense="true" Hover="true" Bordered="true" Striped="true" FixedHeader="true">
        <HeaderContent>
          <MudTh>Consignee</MudTh>
        <MudTh>Start Time</MudTh>
               <MudTh>End Time</MudTh>
         <MudTh Style="text-align: center">Actions</MudTh>
          </HeaderContent>
     <RowTemplate>
                    <MudTd>@GetConsigneeName(context.Consignee)</MudTd>
   <MudTd>@context.From.LocalDateTime.ToString("g")</MudTd>
           <MudTd>@context.To.LocalDateTime.ToString("g")</MudTd>
        <MudTd Style="text-align: center">
            <MudStack Row="true" Justify="Justify.Center" Spacing="2">
   <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => OpenEditDialog(context))" />
     <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => OpenDeleteDialog(context))" />
                   </MudStack>
    </MudTd>
  </RowTemplate>
           </MudTable>
     </div>
     </MudPaper>
              </MudItem>
     }

             @if (showCalendar)
   {
         <MudItem xs="@(showTable ? 6 : 12)" Class="scrollable-panel">
       <MudPaper Class="pa-4 d-flex flex-column" Style="height: 100%;">
               <div class="scroll-content">
     <RadzenScheduler TItem="ScheduleAppointment" 
     Data=@appointments 
              StartProperty="Start" 
           EndProperty="End"
               TextProperty="Text" 
   SelectedIndex="2" 
     SlotRender="OnSlotRender" 
         AppointmentRender="OnAppointmentRender"
       AppointmentMouseEnter=@OnAppointmentMouseEnter 
           AppointmentMouseLeave=@OnAppointmentMouseLeave
        Style="height: 100%;">
     <RadzenDayView />
      <RadzenWeekView />
 <RadzenMonthView />
          <RadzenYearView />
 </RadzenScheduler>
           </div>
  </MudPaper>
        </MudItem>
        }
     </MudGrid>
        }
    </MudContainer>
}

@code {
    private bool isInitialized = false;
    private bool showTable = true;
    private bool showCalendar = true;
    private List<Schedule> scheduleList = new();
    private List<Consignee> consigneesList = new();
    private string selectedConsigneeKey = "";
    private RadzenScheduler<ScheduleAppointment>? scheduler;
    private IList<ScheduleAppointment> appointments = new List<ScheduleAppointment>();

    protected override async Task OnInitializedAsync()
    {
        await FilePathService.InitializeAsync();

        if (FilePathService.HasValidPath)
        {
            await ExcelService.InitializeAsync(FilePathService.CurrentPath!);
            await RefreshData();
            isInitialized = true;
        }
    }

    void OnAppointmentMouseEnter(SchedulerAppointmentMouseEventArgs<ScheduleAppointment> args)
    {
        var color = GetConsigneeColor(consigneesList, args.Data.ConsigneeKey);

        TooltipService.Open(args.Element, ts =>
            @<RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0" class="rz-p-6" Style="min-width: 250px; max-width: 500px;">
            <RadzenText TextStyle="TextStyle.H4" class="rz-mb-4" Style="color: var(--rz-tooltip-color);">
                    @args.Data.Text
                </RadzenText>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="4px">
                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color); width: 44px;">
                        <strong>Start</strong>
                    </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color);">
                        @args.Data.Start.ToString("hh:mm ⋅ dddd, MMMM d")
                    </RadzenText>
                </RadzenStack>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="4px">
                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color); width: 44px;">
                        <strong>End</strong>
                    </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color);">
                        @args.Data.End.ToString("hh:mm ⋅ dddd, MMMM d")
                    </RadzenText>
                </RadzenStack>
            </RadzenStack>
            , new TooltipOptions { Position = TooltipPosition.Top, Duration = null, Style = $"background: {color}" });
    }

    void OnAppointmentMouseLeave(SchedulerAppointmentMouseEventArgs<ScheduleAppointment> args)
    {
        TooltipService.Close();
    }

    private async Task RefreshData()
    {
        scheduleList = await ExcelService.GetAllSchedulesAsync();
        consigneesList = ExcelService.GetAllConsignees();
        UpdateAppointments();
    }

    private void UpdateAppointments()
    {
        appointments = scheduleList.Select(s => new ScheduleAppointment
        {
            Start = s.From.LocalDateTime,
            End = s.To.LocalDateTime,
            Text = GetConsigneeName(s.Consignee),
            ConsigneeKey = s.Consignee,
            LineNumber = s.LineNumber
        }).ToList();
    }

    private string GetConsigneeName(string? consigneeKey)
    {
        return consigneesList.FirstOrDefault(p => p.Key == consigneeKey)?.Name ?? "Unknown";
    }

    void OnSlotRender(SchedulerSlotRenderEventArgs args)
    {
        // You can customize the appearance of slots here if needed

        // Highlight today in month view
        if (args.View.Text == "Month" && args.Start.Date == DateTime.Today)
        {
            args.Attributes["style"] = "background: var(--rz-scheduler-highlight-background-color, rgba(255,220,40,.2));";
        }
    }

    void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<ScheduleAppointment> args)
    {
        // You can customize the appearance of appointments here if needed
        var appointment = args.Data;

        var color = GetConsigneeColor(consigneesList, appointment.ConsigneeKey);

        args.Attributes["style"] = $"background: {color};";
    }

    private static string GetConsigneeColor(IEnumerable<Consignee> consignees, string consigneeKey)
    {
        var consigneeIndex = consignees
            .OrderBy(c => c.Key).Select((c, i) => new { Index = i, Consignee = c })
            .FirstOrDefault(x => x.Consignee.Key == consigneeKey)?.Index;

        return consigneeIndex switch
        {
            0 => "var(--rz-series-1)",
            1 => "var(--rz-series-2)",
            2 => "var(--rz-series-3)",
            3 => "var(--rz-series-4)",
            4 => "var(--rz-series-8)",
            5 => "var(--rz-series-6)",
            6 => "var(--rz-series-7)",
            7 => "var(--rz-series-5)",
            _ => "var(--rz-danger)"
        };
    }

    async Task OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<ScheduleAppointment> args)
    {
        var schedule = scheduleList.FirstOrDefault(s => s.LineNumber == args.Data.LineNumber);
        if (schedule != null)
        {
            await OpenEditDialog(schedule);
        }
    }

    async Task OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        var parameters = new DialogParameters
        {
            ["ConsigneesList"] = consigneesList,
            ["Schedule"] = new Schedule
            {
                From = args.Start,
                To = args.End
            }
        };

        var dialog = DialogService.Show<ScheduleDialog>("Add Schedule", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var newSchedule = (Schedule)result.Data;
            await ExcelService.AddScheduleAsync(newSchedule);
            await RefreshData();
            Snackbar.Add("Schedule added successfully", Severity.Success);
        }
    }

    private async Task OpenAddDialog()
    {
        var parameters = new DialogParameters
        {
            ["ConsigneesList"] = consigneesList
        };

        var dialog = DialogService.Show<ScheduleDialog>("Add Schedule", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var newSchedule = (Schedule)result.Data;
            await ExcelService.AddScheduleAsync(newSchedule);
            await RefreshData();
            Snackbar.Add("Schedule added successfully", Severity.Success);
        }
    }

    private async Task OpenEditDialog(Schedule schedule)
    {
        var parameters = new DialogParameters
        {
            ["Schedule"] = schedule,
            ["ConsigneesList"] = consigneesList
        };

        var dialog = DialogService.Show<ScheduleDialog>("Edit Schedule", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var updatedSchedule = (Schedule)result.Data;
            await ExcelService.UpdateScheduleAsync(updatedSchedule);
            await RefreshData();
            Snackbar.Add("Schedule updated successfully", Severity.Success);
        }
    }

    private async Task OpenDeleteDialog(Schedule schedule)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete this schedule? This action cannot be undone."
        };

        var dialog = DialogService.Show<ConfirmDialog>("Confirm Delete", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await ExcelService.DeleteScheduleAsync(schedule.LineNumber);
            await RefreshData();
            Snackbar.Add("Schedule deleted successfully", Severity.Success);
        }
    }

    public class ScheduleAppointment
    {
        public DateTime Start { get; set; }
        public DateTime End { get; set; }
        public string Text { get; set; }
        public string ConsigneeKey { get; set; }
        public int LineNumber { get; set; }
    }
}