@page "/settings"
@using MessagebirdTools.WebApp.Models
@using MessagebirdTools.WebApp.Services
@inject IExcelService ExcelService
@inject IFilePathService FilePathService
@inject ISnackbar Snackbar

<PageTitle>Application Settings</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Application Settings</MudText>

@if (!isInitialized)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    <MudText>Initializing...</MudText>
}
else
{
    <MudPaper Class="pa-4">
        <MudForm @ref="form" @bind-IsValid="@success">
            <MudTextField @bind-Value="settings.ApiKey" Label="API Key" />
            <MudTextField @bind-Value="settings.DatabaseKey" Label="Database Key" />
            <MudTextField @bind-Value="settings.DatabaseRecordKey" Label="Database Record Key" />
            
            <MudText Typo="Typo.body2" Class="mt-4 mb-2">Current Excel File Path</MudText>
            <MudText Typo="Typo.caption">@FilePathService.CurrentPath</MudText>
            
            <MudButton Variant="MudBlazor.Variant.Filled" Color="Color.Primary" OnClick="UpdateSettings" Class="mt-4">Update Settings</MudButton>
            <MudText Typo="Typo.caption" Class="mt-2">Note: Settings will be saved to Excel when you click the Save button in the top menu</MudText>
        </MudForm>
    </MudPaper>
}

@code {
    private bool isInitialized = false;
    private bool success = false;
    private AppSettings settings = new();
    private MudForm form = null!;

    protected override async Task OnInitializedAsync()
    {
        await FilePathService.InitializeAsync();

        if (FilePathService.HasValidPath)
        {
            await ExcelService.InitializeAsync(FilePathService.CurrentPath!);
            RefreshData();
            isInitialized = true;
        }
    }

    private void RefreshData()
    {
        settings = ExcelService.GetSettings();
    }

    private async Task UpdateSettings()
    {
        await form.Validate();
        
        if (success)
        {
            ExcelService.UpdateSettings(settings);
            Snackbar.Add("Settings updated in memory. Click Save in the top menu to persist changes.", Severity.Success);
        }
    }
}